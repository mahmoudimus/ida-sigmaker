name: Release

on:
    workflow_run:
        workflows: ["ida-sigmaker tests"] # Reference the test workflow name
        types:
            - completed

jobs:
    release:
        runs-on: ubuntu-24.04
        if: ${{ github.event.workflow_run.conclusion == 'success' && startsWith(github.ref, 'refs/tags/v') }}
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Extract version from tag
              id: version
              run: |
                  echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
                  echo "version_clean=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Create sigmaker.py from __init__.py
              run: |
                  cp src/sigmaker/__init__.py sigmaker.py

            - name: ✏️ Create release body
              run: |
                  cat > release_body.md << 'EOF'
                  # sigmaker.py - IDA Python Standalone Python Release

                  ## Release Information
                  - **Version**: ${{ steps.version.outputs.version }}
                  - **Source**: https://github.com/mahmoudimus/ida-sigmaker
                  - **Author**: @mahmoudimus (Mahmoud Abdelkader)

                  ## Description
                  This is a standalone release of the IDA Pro signature maker plugin. The file `sigmaker.py` contains the complete plugin code that can be directly imported into IDA Pro.

                  ## Installation
                  1. Copy `sigmaker.py` to your IDA Pro plugins directory
                  2. Restart IDA Pro
                  3. Use Ctrl+Alt+S to access the Signature Maker menu

                  ## License
                  See the main repository for license information.
                  EOF

                  echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
                  cat release_body.md >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV
                  rm release_body.md

            - name: 📦 Generate Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      sigmaker.py
                  draft: false
                  generate_release_notes: false
                  tag_name: ${{ steps.version.outputs.version }}
                  body: ${{ env.RELEASE_BODY }}
                  prerelease: ${{ github.ref != 'refs/heads/main' }}
                  name: ${{ steps.version.outputs.version }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
